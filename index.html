<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ë°°ìˆ˜ë¡œ ì„¤ì¹˜ ìœ„ì¹˜ ê´€ë¦¬ ì§€ë„</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
body {
  margin:0; padding:0;
  font-family: Arial,"Noto Sans KR",sans-serif;
  background:#f5f5f5;
}
.panel {
  max-width:900px; margin:20px auto;
  padding:16px; background:#fff;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
.controls {
  display:flex; align-items:center; gap:14px; flex-wrap:wrap;
}
.controls select {
  width:160px; height:38px;
  padding:6px; border-radius:6px; border:1px solid #ccc;
}
.controls button {
  height:38px; padding:0 18px;
  background:#0A8A27; color:#fff;
  border:0; border-radius:6px;
  cursor:pointer; white-space:nowrap; font-size:14px;
}
#map {
  width:100%; height:600px; margin-top:20px;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,0.15);
}
#editor {
  position:fixed; right:20px; top:80px;
  width:320px; background:#fff;
  border-radius:10px; padding:14px;
  box-shadow:0 4px 18px rgba(0,0,0,0.25);
  display:none; z-index:5000;
}
#editor input, #editor textarea, #editor select {
  width:100%; padding:8px; margin-top:6px;
  border:1px solid #ccc; border-radius:6px;
}
#editor button {
  margin-top:8px; padding:8px 12px;
  border-radius:6px; border:0;
  cursor:pointer;
}
button.save { background:#0A8A27; color:#fff; }
button.delete { background:#C62828; color:#fff; }
button.close { background:#555; color:#fff; }
</style>
</head>

<body>

<div class="panel">
  <h2>ë°°ìˆ˜ë¡œ ì„¤ì¹˜ ìœ„ì¹˜ ê´€ë¦¬ ì§€ë„</h2>
  <p>ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ìƒˆë¡œìš´ ë°°ìˆ˜ë¡œ ì§€ì ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
  ë§ˆì»¤ë¥¼ í´ë¦­í•˜ì—¬ ì œëª©Â·ì„¤ëª…Â·ìš°ì„ ìˆœìœ„Â·ìƒíƒœë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

  <div class="controls">
    <label>ìƒíƒœ í•„í„°</label>
    <select id="filter">
      <option value="all">ì „ì²´</option>
      <option value="ë¯¸ì„¤ì¹˜">ë¯¸ì„¤ì¹˜</option>
      <option value="ì„¤ì¹˜ì™„ë£Œ">ì„¤ì¹˜ì™„ë£Œ</option>
    </select>

    <button id="refresh">ë§ˆì»¤ ìƒˆë¡œê³ ì¹¨</button>
    <button id="export">CSV ë‚´ë³´ë‚´ê¸°</button>
  </div>
</div>

<div id="map"></div>

<div id="editor">
  <h3>ë§ˆì»¤ ì •ë³´</h3>
  <label>ì œëª©</label><input id="ed_title">
  <label>ì„¤ëª…</label><textarea id="ed_desc" rows="3"></textarea>
  <label>ìš°ì„ ìˆœìœ„</label>
  <select id="ed_priority">
    <option>ë‚®ìŒ</option>
    <option>ë³´í†µ</option>
    <option>ë†’ìŒ</option>
  </select>
  <label>ìƒíƒœ</label>
  <select id="ed_status">
    <option>ë¯¸ì„¤ì¹˜</option>
    <option>ì„¤ì¹˜ì™„ë£Œ</option>
  </select>

  <button class="save" id="saveBtn">ì €ì¥</button>
  <button class="delete" id="delBtn">ì‚­ì œ</button>
  <button class="close" id="closeBtn">ë‹«ê¸°</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ğŸš€ ìƒˆ ì›¹ì•± URL ì ìš© ì™„ë£Œ
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqFywFXt6hpyliAyvGb8R-LXzN57AWixZWJGazv_m5TmcA1WNFeD4p0hogy9bo9n9t/exec";

const map = L.map('map').setView([36.5,127.9],8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markers = {};
let editingId = null;

function safe(t) {
  if (!t) return "";
  return String(t).replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

// ------------------------
// ë§ˆì»¤ ë¶ˆëŸ¬ì˜¤ê¸°
// ------------------------
async function loadMarkers() {
  const res = await fetch(SCRIPT_URL + "?action=getMarkers");
  const data = await res.json();

  Object.values(markers).forEach(m => map.removeLayer(m.leaflet));
  markers = {};

  data.forEach(item => {
    const m = L.marker([item.lat, item.lng]).addTo(map);
    m.bindPopup("<b>" + safe(item.title) + "</b><br>" + safe(item.description));
    m.on('click', () => openEditor(item.id));
    markers[item.id] = { leaflet: m, data: item };
  });
}

document.getElementById("refresh").onclick = loadMarkers;

// ------------------------
// ì§€ë„ í´ë¦­ â†’ ìƒˆ ë§ˆì»¤ ì¶”ê°€
// ------------------------
map.on('click', e => {
  const tempId = "temp_" + Date.now();

  const m = L.marker([e.latlng.lat, e.latlng.lng], { draggable: true }).addTo(map);

  markers[tempId] = {
    leaflet: m,
    data: {
      id: tempId,
      lat: e.latlng.lat,
      lng: e.latlng.lng,
      title: "",
      description: "",
      priority: "ë³´í†µ",
      status: "ë¯¸ì„¤ì¹˜"
    }
  };

  openEditor(tempId);
});

// ------------------------
// í¸ì§‘ì°½ ì—´ê¸°
// ------------------------
function openEditor(id) {
  editingId = id;
  const item = markers[id].data;

  document.getElementById("ed_title").value = item.title || "";
  document.getElementById("ed_desc").value = item.description || "";
  document.getElementById("ed_priority").value = item.priority || "ë³´í†µ";
  document.getElementById("ed_status").value = item.status || "ë¯¸ì„¤ì¹˜";

  document.getElementById("editor").style.display = "block";
}

document.getElementById("closeBtn").onclick = () => {
  document.getElementById("editor").style.display = "none";
};

// ------------------------
// ì €ì¥ (Add / Update)
// ------------------------
document.getElementById("saveBtn").onclick = async () => {
  const item = markers[editingId].data;

  item.title = document.getElementById("ed_title").value;
  item.description = document.getElementById("ed_desc").value;
  item.priority = document.getElementById("ed_priority").value;
  item.status = document.getElementById("ed_status").value;

  if (editingId.startsWith("temp_")) {
    const res = await fetch(SCRIPT_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ action:"add", marker:item })
    });
    const json = await res.json();

    if (json.id) {
      item.id = json.id;
      markers[item.id] = markers[editingId];
      delete markers[editingId];
      editingId = item.id;
    }
  } else {
    await fetch(SCRIPT_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ action:"update", marker:item })
    });
  }

  alert("ì €ì¥ ì™„ë£Œ");
  document.getElementById("editor").style.display="none";
  loadMarkers();
};

// ------------------------
// ì‚­ì œ
// ------------------------
document.getElementById("delBtn").onclick = async () => {
  if (editingId.startsWith("temp_")) {
    map.removeLayer(markers[editingId].leaflet);
    delete markers[editingId];
  } else {
    await fetch(SCRIPT_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ action:"delete", id:editingId })
    });
  }

  alert("ì‚­ì œ ì™„ë£Œ");
  document.getElementById("editor").style.display="none";
  loadMarkers();
};

// ------------------------
// CSV ë‚´ë³´ë‚´ê¸°
// ------------------------
document.getElementById("export").onclick = () => {
  const rows = [["id","lat","lng","title","description","priority","status"]];

  Object.values(markers).forEach(m => {
    const d = m.data;
    rows.push([d.id,d.lat,d.lng,d.title,d.description,d.priority,d.status]);
  });

  const csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "markers.csv";
  a.click();
};

loadMarkers();
</script>

</body>
</html>

