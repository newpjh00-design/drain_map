<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ë°°ìˆ˜ë¡œ ì„¤ì¹˜ ìœ„ì¹˜ ê´€ë¦¬ ì§€ë„</title>
    <style>
        body {
            margin: 0;
            font-family: "Noto Sans KR", sans-serif;
            background: #f7f7f7;
        }
        #top-panel {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px auto;
            border-radius: 12px;
            width: 90%;
        }
        #map {
            width: 100%;
            height: 80vh;
        }
        .input-group {
            margin-bottom: 8px;
        }
        label {
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 6px;
            margin-top: 3px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        button {
            padding: 8px 12px;
            background: #2f8f2f;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #1e6e1e;
        }
        .popup {
            font-size: 14px;
        }
    </style>

    <!-- Leaflet -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
    </script>
</head>

<body>

<div id="top-panel">
    <h2>ë°°ìˆ˜ë¡œ ì„¤ì¹˜ ìœ„ì¹˜ ê´€ë¦¬ ì§€ë„</h2>
    <p>ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ìƒˆë¡œìš´ ë°°ìˆ˜ë¡œ ì§€ì ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
       ë§ˆì»¤ë¥¼ í´ë¦­í•˜ì—¬ ì£¼ì†ŒÂ·ì œëª©Â·ì„¤ëª…Â·ìš°ì„ ìˆœìœ„Â·ìƒíƒœë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    ìƒíƒœ í•„í„°:
    <select id="statusFilter" onchange="filterMarkers()">
        <option value="ì „ì²´">ì „ì²´</option>
        <option value="ë¯¸ì„¤ì¹˜">ë¯¸ì„¤ì¹˜</option>
        <option value="ì„¤ì¹˜ì™„ë£Œ">ì„¤ì¹˜ì™„ë£Œ</option>
    </select>

    <button onclick="reloadMarkers()">ë§ˆì»¤ ìƒˆë¡œê³ ì¹¨</button>
</div>

<div id="map"></div>

<script>
/***********************
 ğŸ“Œ ë°˜ë“œì‹œ êµì²´í•˜ì„¸ìš”!!
***********************/
const SCRIPT_URL =
    "https://script.google.com/macros/s/AKfycbxqFywFXt6hpyliAyvGb8R-LXzN57AWixZWJGazv_m5TmcA1WNFeD4p0hogy9bo9n9t/exec";


/***********************
 ğŸ“Œ ì§€ë„ ì´ˆê¸° ì„¤ì •
***********************/
let map = L.map("map").setView([35.2, 126.8], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
}).addTo(map);

let markers = [];


/***********************
 ğŸ“Œ ë§ˆì»¤ ë¡œë“œ
***********************/
async function loadMarkers() {
    const res = await fetch(SCRIPT_URL);
    const data = await res.json();

    markers.forEach((m) => map.removeLayer(m));
    markers = [];

    data.forEach((item) => {
        const marker = L.marker([item.lat, item.lng]).addTo(map);

        marker.itemData = item;
        marker.bindPopup(makePopupContent(item));

        markers.push(marker);
    });
}

function reloadMarkers() {
    loadMarkers();
}

function filterMarkers() {
    const status = document.getElementById("statusFilter").value;

    markers.forEach((marker) => {
        if (status === "ì „ì²´" || marker.itemData.status === status) {
            marker.addTo(map);
        } else {
            map.removeLayer(marker);
        }
    });
}


/***********************
 ğŸ“Œ íŒì—… HTML ìƒì„±
***********************/
function makePopupContent(item) {
    return `
    <div class="popup">
        <b>ID:</b> ${item.id}<br>
        
        <b>ì£¼ì†Œ:</b><br>
        <input id="addr-${item.id}" value="${item.address}"><br>

        <b>ì œëª©:</b><br>
        <input id="title-${item.id}" value="${item.title}"><br>

        <b>ì„¤ëª…:</b><br>
        <textarea id="desc-${item.id}">${item.description}</textarea><br>

        <b>ìš°ì„ ìˆœìœ„:</b><br>
        <select id="prio-${item.id}">
            <option ${item.priority==="ë‚®ìŒ"?"selected":""}>ë‚®ìŒ</option>
            <option ${item.priority==="ë³´í†µ"?"selected":""}>ë³´í†µ</option>
            <option ${item.priority==="ë†’ìŒ"?"selected":""}>ë†’ìŒ</option>
        </select><br>

        <b>ìƒíƒœ:</b><br>
        <select id="status-${item.id}">
            <option ${item.status==="ë¯¸ì„¤ì¹˜"?"selected":""}>ë¯¸ì„¤ì¹˜</option>
            <option ${item.status==="ì„¤ì¹˜ì™„ë£Œ"?"selected":""}>ì„¤ì¹˜ì™„ë£Œ</option>
        </select><br><br>

        <button onclick="updateMarker('${item.id}')">ìˆ˜ì •</button>
        <button onclick="deleteMarker('${item.id}')" style="background:#b32d2d">ì‚­ì œ</button>
    </div>`;
}


/***********************
 ğŸ“Œ ì§€ë„ í´ë¦­ â†’ ìƒˆ ë§ˆì»¤ ì¶”ê°€
***********************/
map.on("click", async function (e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    const address = prompt("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
    if (!address) return;

    const title = prompt("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:", "ìƒˆ ë°°ìˆ˜ë¡œ ì§€ì ");
    const desc = prompt("ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:", "");
    const priority = "ë³´í†µ";
    const status = "ë¯¸ì„¤ì¹˜";

    const body = {
        action: "add",
        marker: { address, lat, lng, title, description: desc, priority, status }
    };

    await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify(body),
    });

    loadMarkers();
});


/***********************
 ğŸ“Œ ë§ˆì»¤ ìˆ˜ì •
***********************/
async function updateMarker(id) {
    const address = document.getElementById(`addr-${id}`).value;
    const title = document.getElementById(`title-${id}`).value;
    const desc = document.getElementById(`desc-${id}`).value;
    const priority = document.getElementById(`prio-${id}`).value;
    const status = document.getElementById(`status-${id}`).value;

    const body = {
        action: "update",
        marker: { id, address, title, description: desc, priority, status }
    };

    await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify(body)
    });

    loadMarkers();
}


/***********************
 ğŸ“Œ ë§ˆì»¤ ì‚­ì œ
***********************/
async function deleteMarker(id) {
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify({ action: "delete", id })
    });

    loadMarkers();
}


/***********************
 ğŸ“Œ ì´ˆê¸° ë¡œë“œ
***********************/
loadMarkers();
</script>

</body>
</html>


